@{
    Layout = null;
}
<!DOCTYPE html>

<html>
<head>
    <title>Prova de Desenvolvimento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="~/Content/Site.css" rel="stylesheet" />
</head>
<body>
    <div class="container-fluid mt-5 col-lg-6">
        <h3 class="mb-3">Usuários Cadastrados</h3>
        <div class="d-flex justify-content-end mb-3">
            <a href="~/Home/Create" class="btn btn-primary">Cadastrar</a>
        </div>
        <div id="userTableContainer" class="justify-content-center">
            <p class="text-muted">Carregando lista de usuários...</p>
        </div>
    </div>

    <script src="~/Scripts/jquery-3.7.1.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>


    <script>
        jQuery(document).ready(function () {
            // Listar usuários
            jQuery.ajax({
                url: '/UserViewModels/List',
                type: 'GET',
                DataType: 'json',
                success: function (result) {

                    // O Controller retorna a lista em 'result.usuarios'
                    if (result.usuarios && result.usuarios.length > 0) {
                        var tabelaHtml = '<table class="table table-striped table-hover table-bordered">';

                        // Cabeçalho da Tabela
                        tabelaHtml += '<thead><tr>';
                        tabelaHtml += '<th>Nome</th>';
                        tabelaHtml += '<th>Sobrenome</th>';
                        tabelaHtml += '<th>Email</th>';
                        tabelaHtml += '<th>Data Nascimento</th>';
                        tabelaHtml += '</tr></thead>';

                        tabelaHtml += '<tbody>';

                        function concatenarDataNasc(dataNascimentoStr) {
                            let dataNascimento;

                            // Caso venha como DD/MM/AAAA
                            if (dataNascimentoStr && dataNascimentoStr.includes('/')) {
                                const partes = dataNascimentoStr.split('/');
                                if (partes[0].leng === 4) {
                                    dataNascimento = new Date(partes[0], partes[1] - 1, partes[2]);// Js entendo os meses como 0-11 não 1-12 por isso o mês
                                }
                                else {
                                    dataNascimento = new Date(partes[2], partes[1] - 1, partes[0]); 
                                }
                            }

                            // Se vier como YYYY-MM-DD
                            else if (dataNascimentoStr && dataNascimentoStr.includes('-')) {
                                const partes = dataNascimentoStr.split('-');
                                // Analisa se está no formato YYYY-MM-DD ou DD-MM-YYYY
                                if (partes[0].length === 4) {// Se o primeiro elemento da Data possuir 4 ou mais digitos ele entende como ano
                                    dataNascimento = new Date(partes[0], partes[1] - 1, partes[2]);
                                } else {
                                    dataNascimento = new Date(partes[2], partes[1] - 1, partes[0]);
                                }
                            }

                            if (!dataNascimento || isNaN(dataNascimento)) {
                                return "Data Inválida";
                            }

                            // ---- FORMATA EM DD/MM/AAAA ----
                            const dia = String(dataNascimento.getDate()).padStart(2, '0');
                            const mes = String(dataNascimento.getMonth() + 1).padStart(2, '0');
                            const ano = dataNascimento.getFullYear();

                            return `${dia}/${mes}/${ano}`;
                        }

                        jQuery.each(result.usuarios, function (index, usuario) {

                            var dataNascimento = concatenarDataNasc(usuario.BirthDate);

                            tabelaHtml += '<tr>';
                            tabelaHtml += '<td>' + usuario.FirstName + '</td>';
                            tabelaHtml += '<td>' + usuario.LastName + '</td>';
                            tabelaHtml += '<td>' + usuario.Email + '</td>';
                            tabelaHtml += '<td>' + dataNascimento + '</td>';
                            tabelaHtml += '</tr>';
                        });

                        tabelaHtml += '</tbody></table>';

                        // Insere a tabela no container
                        jQuery("#userTableContainer").html(tabelaHtml);

                    } else {
                        jQuery("#userTableContainer").html('<p class="alert alert-info">Nenhum usuário cadastrado no momento.</p>');
                    }

                },
                error: function () {
                    jQuery("#userTableContainer").html('<p class="alert alert-danger">Erro ao carregar a lista de usuários.</p>');
                    console.error("Falha ao acessar /UserViewModels/List.");
                }
            });
        })
    </script>
</body>
</html>

